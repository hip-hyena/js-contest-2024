const I={test:location.search.indexOf("test=1")>0,debug:location.search.indexOf("debug=1")>0,http:!1,ssl:!0,multipleConnections:!0,asServiceWorker:!1,transport:"websocket",noSharedWorker:location.search.indexOf("noSharedWorker=1")>0};I.http=location.search.indexOf("http=1")>0;I.http=!0;I.http&&(I.transport="https");const oe=I.debug,Be=typeof window<"u"?window:self,ce=Be,A=typeof window<"u"?window:self,V=navigator?navigator.userAgent:null;navigator.userAgent.search(/OS X|iPhone|iPad|iOS/i);navigator.userAgent.toLowerCase().indexOf("android");(()=>{try{return+navigator.userAgent.match(/Chrom(?:e|ium)\/(.+?)(?:\s|\.)/)[1]}catch{}})();const pe="safari"in A||!!(V&&(/\b(iPad|iPhone|iPod)\b/.test(V)||V.match("Safari")&&!V.match("Chrome"))),ge=navigator.userAgent.toLowerCase().indexOf("firefox")>-1;(navigator.maxTouchPoints===void 0||navigator.maxTouchPoints>0)&&navigator.userAgent.search(/iOS|iPhone OS|Android|BlackBerry|BB10|Series ?[64]0|J2ME|MIDP|opera mini|opera mobi|mobi.+Gecko|Windows Phone/i)!=-1;const U=typeof ServiceWorkerGlobalScope<"u"&&self instanceof ServiceWorkerGlobalScope,J=typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope&&!U,Ue=J||U,we=()=>self.clients.matchAll({includeUncontrolled:!1,type:"window"}),ke=(n,...e)=>{try{n.postMessage(...e)}catch(t){console.error("[worker] postMessage error:",t,e)}},be=(n,...e)=>{we().then(t=>{t.length&&t.slice(n?0:-1).forEach(s=>{ke(s,...e)})})},ye=(...n)=>{ke(self,...n)},ve=()=>{};U&&be.bind(null,!1);U&&be.bind(null,!0);const qe=Date.now();function le(){return"["+((Date.now()-qe)/1e3).toFixed(3)+"]"}var M=(n=>(n[n.None=0]="None",n[n.Error=1]="Error",n[n.Warn=2]="Warn",n[n.Log=4]="Log",n[n.Debug=8]="Debug",n))(M||{});const je=[0,1,2,4,8],ze=pe||ge,Ge=!ze,ue={reset:"\x1B[0m",bright:"\x1B[1m",dim:"\x1B[2m",underscore:"\x1B[4m",blink:"\x1B[5m",reverse:"\x1B[7m",hidden:"\x1B[8m",fg:{black:"\x1B[30m",red:"\x1B[31m",green:"\x1B[32m",yellow:"\x1B[33m",blue:"\x1B[34m",magenta:"\x1B[35m",cyan:"\x1B[36m",white:"\x1B[37m"},bg:{black:"\x1B[40m",red:"\x1B[41m",green:"\x1B[42m",yellow:"\x1B[43m",blue:"\x1B[44m",magenta:"\x1B[45m",cyan:"\x1B[46m",white:"\x1B[47m"}},Ve=[["debug",8],["info",4],["warn",2],["error",1],["assert",1],["trace",4],["group",4],["groupCollapsed",4],["groupEnd",4]];function q(n,e=7,t=!1,s=""){let i;!oe&&!t&&(e=1),Ge?s||(U?s=ue.fg.yellow:J&&(s=ue.fg.cyan)):s="";const r=s;s?s=`%s ${s}%s`:s="%s";const o=function(...a){return e&4&&console.log(s,le(),n,...a)};return Ve.forEach(([a,c])=>{o[a]=function(...l){return e&c&&console[a](s,le(),n,...l)}}),o.setPrefix=function(a){i=a,n="["+a+"]"},o.setPrefix(n),o.setLevel=function(a){e=je.slice(0,a+1).reduce((c,l)=>c|l,0)},o.bindPrefix=function(a,c=e){return q(`${i}] [${a}`,c,t,r)},o}function Se(n){return new Promise(e=>{setTimeout(e,n)})}const He=self,Te="cachedAssets";function X(n){return n.ok&&n.status===200}function he(n){return Promise.race([n,Se(1e4).then(()=>Promise.reject())])}async function Ke(n){try{const e=await he(He.caches.open(Te)),t=await he(e.match(n.request,{ignoreVary:!0}));if(t&&X(t))return t;const s={Vary:"*"};let i=await fetch(n.request,{headers:s});if(X(i))e.put(n.request,i.clone());else if(i.status===304){const r=n.request.url.replace(/\?.+$/,"")+"?"+(Math.random()*1e5|0);i=await fetch(r,{headers:s}),X(i)&&e.put(n.request,i.clone())}return i}catch{return fetch(n.request)}}function Je(n,e){return new Promise(t=>{const s=new FileReader;s.addEventListener("loadend",i=>{t(i.target.result)}),s[e](n)})}function Ye(n){return Je(n,"readAsArrayBuffer")}function Xe(n){return Ye(n).then(e=>new Uint8Array(e))}function Pe(){}const Qe={isFulfilled:!1,isRejected:!1,notify:()=>{},notifyAll:function(...n){this.lastNotify=n,this.listeners?.forEach(e=>e(...n))},addNotifyListener:function(n){this.lastNotify&&n(...this.lastNotify),(this.listeners??(this.listeners=[])).push(n)},resolve:function(n){this.isFulfilled||this.isRejected||(this.isFulfilled=!0,this._resolve(n),this.onFinish())},reject:function(...n){this.isRejected||this.isFulfilled||(this.isRejected=!0,this._reject(...n),this.onFinish())},onFinish:function(){this.notify=this.notifyAll=this.lastNotify=null,this.listeners&&(this.listeners.length=0),this.cancel&&(this.cancel=Pe)}};function j(){let n,e;const t=new Promise((s,i)=>{n=s,e=i});return Object.assign(t,Qe),t._resolve=n,t._reject=e,t}self.deferredPromise=j;function Ze(n,e,t=!0,s=!0){let i,r,o,a,c=!1;const l=h=>{const m=o,p=a;try{const d=n.apply(null,h);m(d)}catch(d){console.error("debounce error",d),p(d)}},u=(...h)=>{r||(r=new Promise((p,d)=>(o=p,a=d))),i?(clearTimeout(i),c=!0,a(),r=new Promise((p,d)=>(o=p,a=d))):t&&(l(h),c=!1);const m=A.setTimeout(()=>{s&&(!t||c)&&l(h),i===m&&(i=r=o=a=void 0,c=!1)},e);return i=m,r.catch(Pe),r};return u.clearTimeout=()=>{i&&(A.clearTimeout(i),a(),i=r=o=a=void 0,c=!1)},u.isDebounced=()=>!!i,u}function et(n){return["image/jpeg","image/png","image/gif","image/svg+xml","image/webp","image/bmp","video/mp4","video/webm","video/quicktime","audio/ogg","audio/mpeg","audio/mp4","audio/wav","application/json","application/pdf"].indexOf(n)===-1?"application/octet-stream":n}function Ce(n,e=""){Array.isArray(n)||(n=[n]);const t=et(e);return new Blob(n,{type:t})}class tt{constructor(e,t,s){this.mimeType=e,this.size=t,this.saveFileCallback=s,this.bytes=new Uint8Array(t)}async write(e,t){const s=t+e.byteLength;if(s>this.bytes.byteLength){const i=new Uint8Array(s);i.set(this.bytes,0),this.bytes=i}this.bytes.set(e,t)}truncate(){this.bytes=new Uint8Array}trim(e){this.bytes=this.bytes.slice(0,e)}finalize(e=!0){const t=Ce(this.bytes,this.mimeType);return e&&this.saveFileCallback&&this.saveFileCallback(t),t}getParts(){return this.bytes}replaceParts(e){this.bytes=e}}const Q={};function W(n){return Q[n]??(Q[n]={type:n})}const x=class x{constructor(e){this.dbName=e,this.useStorage=!0,I.test&&(this.dbName+="_test"),x.STORAGES.length&&(this.useStorage=x.STORAGES[0].useStorage),this.openDatabase(),x.STORAGES.push(this)}openDatabase(){return this.openDbPromise??(this.openDbPromise=caches.open(this.dbName))}delete(e){return this.timeoutOperation(t=>t.delete("/"+e))}deleteAll(){return caches.delete(this.dbName)}get(e){return this.timeoutOperation(t=>t.match("/"+e))}save(e,t){return this.timeoutOperation(s=>s.put("/"+e,t))}getFile(e,t="blob"){return this.get(e).then(s=>{if(!s)throw W("NO_ENTRY_FOUND");return s[t]()})}saveFile(e,t){t instanceof Blob||(t=Ce(t));const s=new Response(t,{headers:{"Content-Length":""+t.size}});return this.save(e,s).then(()=>t)}timeoutOperation(e){return this.useStorage?new Promise(async(t,s)=>{let i=!1;const r=setTimeout(()=>{s(),i=!0},15e3);try{const o=await this.openDatabase();if(!o)throw this.useStorage=!1,this.openDbPromise=void 0,"no cache?";const a=await e(o);if(i)return;t(a)}catch(o){s(o)}clearTimeout(r)}):Promise.reject(W("STORAGE_OFFLINE"))}prepareWriting(e,t,s){return{deferred:j(),getWriter:()=>new tt(s,t,r=>this.saveFile(e,r).catch(()=>r))}}static toggleStorage(e,t){return Promise.all(this.STORAGES.map(s=>{if(s.useStorage=e,!!t&&!e)return s.deleteAll()}))}};x.STORAGES=[];let H=x;function st(n){return new Promise(e=>{setTimeout(()=>{e(new Response("",{status:408,statusText:"Request timed out."}))},n)})}const _=new Map,se=new H("cachedStreamChunks"),nt=86400,Ae="Time-Cached",it=()=>se.timeoutOperation(n=>n.keys().then(e=>{const t=new Map,s=Date.now()/1e3|0;for(const r of e){const o=r.url.match(/\/(\d+?)\?/);o&&!t.has(o[1])&&t.set(o[1],r)}const i=[];for(const[r,o]of t){const a=n.match(o).then(c=>{if(+c.headers.get(Ae)+nt<=s)return f("will delete stream chunk:",r),n.delete(o,{ignoreSearch:!0,ignoreVary:!0})});i.push(a)}return Promise.all(i)}));setInterval(it,18e5);setInterval(()=>{const n=Y();for(const[e,t]of _)if(e!==n){for(const s in t)t[s].reject();_.delete(e)}},12e4);const Z=new Map;class K{constructor(e){this.info=e,this.loadedOffsets=new Set,this.destroy=()=>{Z.delete(this.id)},this.id=K.getId(e),Z.set(this.id,this),this.limitPart=e.size>75*1024*1024?ct:at,this.destroyDebounced=Ze(this.destroy,15e4,!1,!0)}async requestFilePartFromWorker(e,t,s=!1){const i={docId:this.id,dcId:this.info.dcId,offset:e,limit:t},r=JSON.stringify(i),o=Y();let a=_.get(o);a||_.set(o,a={});let c=a[r];if(c)return c.then(u=>u.bytes);this.loadedOffsets.add(e),c=a[r]=j(),b.invoke("requestFilePart",i,void 0,o).then(c.resolve.bind(c),c.reject.bind(c)).finally(()=>{a[r]===c&&(delete a[r],Object.keys(a).length||_.delete(o))});const l=c.then(u=>u.bytes);return this.saveChunkToCache(l,e,t),!s&&this.preloadChunks(e,e+this.limitPart*15),l}requestFilePartFromCache(e,t,s){const i=this.getChunkKey(e,t);return se.getFile(i).then(r=>s?new Uint8Array:Xe(r),r=>{r.type})}requestFilePart(e,t,s){return this.requestFilePartFromCache(e,t,s).then(r=>r||this.requestFilePartFromWorker(e,t,s))}saveChunkToCache(e,t,s){return e.then(i=>{const r=this.getChunkKey(t,s),o=new Response(i,{headers:{"Content-Length":""+i.length,"Content-Type":"application/octet-stream",[Ae]:""+(Date.now()/1e3|0)}});return se.save(r,o)})}preloadChunk(e){this.loadedOffsets.has(e)||(this.loadedOffsets.add(e),this.requestFilePart(e,this.limitPart,!0))}preloadChunks(e,t){if(t>this.info.size&&(t=this.info.size),!e)this.preloadChunk(de(e,this.limitPart));else for(;e<t;e+=this.limitPart)this.preloadChunk(e)}requestRange(e){this.destroyDebounced();const t=ot(e,this.info.mimeType,this.info.size);if(t)return t;let[s,i]=e;const r=i&&i<this.limitPart?ht(i-s+1):this.limitPart,o=de(s,r);return i||(i=Math.min(s+r,this.info.size-1)),this.requestFilePart(o,r).then(a=>{(s!==o||i!==o+r)&&(a=a.slice(s-o,i-o+1));const c={"Accept-Ranges":"bytes","Content-Range":`bytes ${s}-${s+a.byteLength-1}/${this.info.size||"*"}`,"Content-Length":`${a.byteLength}`};return this.info.mimeType&&(c["Content-Type"]=this.info.mimeType),new Response(a,{status:206,statusText:"Partial Content",headers:c})})}getChunkKey(e,t){return this.id+"?offset="+e+"&limit="+t}static get(e){return Z.get(this.getId(e))??new K(e)}static getId(e){return e.location.id}}function rt(n,e){const t=ut(n.request.headers.get("Range")),s=JSON.parse(decodeURIComponent(e)),i=K.get(s);n.respondWith(Promise.race([st(45*1e3),i.requestRange(t)]))}function ot(n,e,t){return n[0]===0&&n[1]===1?new Response(new Uint8Array(2).buffer,{status:206,statusText:"Partial Content",headers:{"Accept-Ranges":"bytes","Content-Range":`bytes 0-1/${t||"*"}`,"Content-Length":"2","Content-Type":e||"video/mp4"}}):null}const at=512*1024,ct=1024*1024,lt=512*4;function ut(n){if(!n)return[0,0];const[,e]=n.split("="),t=e.split(", "),[s,i]=t[0].split("-");return[+s,+i||0]}function de(n,e=lt){return n-n%e}function ht(n){return 2**Math.ceil(Math.log(n)/Math.log(2))}const g={1718909296:{id:"ftyp",cont:!1},1718773093:{id:"free",cont:!1},1835295092:{id:"mdat",cont:!1},1836019574:{id:"moov",cont:!0},1836019558:{id:"moof",cont:!0},1835430497:{id:"mfra",cont:!1},1936286840:{id:"sidx",cont:!1},1836476516:{id:"mvhd",cont:!1},1953653099:{id:"trak",cont:!0,many:!0},1836475768:{id:"mvex",cont:!0},1969517665:{id:"udta",cont:!1},1835427940:{id:"mfhd",cont:!1,fullbox:!0,fields:[[32,"seqNum","uint"]]},1953653094:{id:"traf",cont:!0,many:!0},1953196132:{id:"tkhd",cont:!1,fullbox:!0,fields:[[32,"creationTime","uint",{cond:["version","=",0]}],[32,"modificationTime","uint",{cond:["version","=",0]}],[64,"creationTime","uint",{cond:["version","=",1]}],[64,"modificationTime","uint",{cond:["version","=",1]}],[32,"trackId","uint"],[32],[32,"duration","uint",{cond:["version","=",0]}],[64,"duration","uint",{cond:["version","=",1]}],[64],[16,"layer","int",{template:0}],[16,"alternateGroup","int",{template:0}],[16,"volume","int"],[16],[32,"matrix","int",{repeat:9}],[32,"width","uint"],[32,"height","uint"]]},1701082227:{id:"edts",cont:!0},1835297121:{id:"mdia",cont:!0},1952868452:{id:"tfhd",cont:!1,fullbox:!0,fields:[[32,"trackId","uint"],[64,"baseDataOffset","uint",{flag:1}],[32,"sampleDescriptionIndex","uint",{flag:2}],[32,"defaultSampleDuration","uint",{flag:8}],[32,"defaultSampleSize","uint",{flag:16}],[32,"defaultSampleFlags","uint",{flag:32}]]},1952867444:{id:"tfdt",cont:!1,fullbox:!0,fields:[[32,"baseMediaDecodeTime","uint",{cond:["version","=",0]}],[64,"baseMediaDecodeTime","uint",{cond:["version","=",1]}]]},1953658222:{id:"trun",cont:!1,fullbox:!0,fields:[[32,"sampleCount","uint"],[32,"dataOffset","int",{flag:1}],[32,"firstSampleFlags","uint",{flag:4}],[-1,"samples",[[32,"duration","uint",{flag:256}],[32,"size","uint",{flag:512}],[32,"flags","uint",{flag:1024}],[32,"sampleCompositionTimeOffset","uint",{flag:2048,cond:["version","=",0]}],[32,"sampleCompositionTimeOffset","int",{flag:2048,cond:["version","!=",0]}]],{repeat:"sampleCount"}]]},1835296868:{id:"mdhd",cont:!1,fullbox:!0,fields:[[32,"creationTime","uint",{cond:["version","=",0]}],[32,"modificationTime","uint",{cond:["version","=",0]}],[64,"creationTime","uint",{cond:["version","=",1]}],[64,"modificationTime","uint",{cond:["version","=",1]}],[32,"timescale","uint"],[32,"duration","uint",{cond:["version","=",0]}],[64,"duration","uint",{cond:["version","=",1]}],[1],[5,"language","int",{repeat:3}],[16]]},1751411826:{id:"hdlr",cont:!1},1835626086:{id:"minf",cont:!0},1986881636:{id:"vmhd",cont:!1},1936549988:{id:"smhd",cont:!1},1684631142:{id:"dinf",cont:!0},1937007212:{id:"stbl",cont:!0},1937011556:{id:"stsd",cont:!0,fullbox:!0,fields:[[32,"entryCount","uint"]]},1937011827:{id:"stts",cont:!1,fullbox:!0,fields:[[32,"entryCount","uint"],[-1,"entries",[[32,"sampleCount","uint"],[32,"sampleDelta","uint"]],{repeat:"entryCount"}]]},1937011571:{id:"stss",cont:!1,fullbox:!0,fields:[[32,"entryCount","uint"],[32,"sampleNumber","uint",{repeat:"entryCount"}]]},1668576371:{id:"ctts",cont:!1,fullbox:!0,fields:[[32,"entryCount","uint"],[-1,"entries",[[32,"sampleCount","uint"],[32,"sampleOffset","uint"]],{repeat:"entryCount",cond:["version","=",0]}],[-1,"entries",[[32,"sampleCount","uint"],[32,"sampleOffset","int"]],{repeat:"entryCount",cond:["version","=",1]}]]},1937011555:{id:"stsc",cont:!1,fullbox:!0,fields:[[32,"entryCount","uint"],[-1,"entries",[[32,"firstChunk","uint"],[32,"samplesPerChunk","uint"],[32,"sampleDescriptionIndex","uint"]],{repeat:"entryCount"}]]},1937011578:{id:"stsz",cont:!1,fullbox:!0,fields:[[32,"sampleSize","uint"],[32,"sampleCount","uint"],[-1,"samples",[[32,"size","uint"]],{repeat:"sampleCount",cond:["sampleSize","=",0]}]]},1937007471:{id:"stco",cont:!1,fullbox:!0,fields:[[32,"entryCount","uint"],[32,"chunkOffset","uint",{repeat:"entryCount"}]]},1936158820:{id:"sgpd",cont:!1},1935828848:{id:"sbgp",cont:!1},1701606260:{id:"elst",cont:!1},1685218662:{id:"dref",cont:!1},1635148593:{id:"avc1",cont:!1},1953654136:{id:"trex",cont:!1,fullbox:!0,fields:[[32,"trackId","uint"],[32,"defaultSampleDescriptionIndex","uint"],[32,"defaultSampleDuration","uint"],[32,"defaultSampleSize","uint"],[32,"defaultSampleFlags","uint"]]}};for(const n of Object.keys(g))g[g[n].id]=parseInt(n);function ae(n,e,t){if(n&&n.flag&&!(t.flags&n.flag))return!1;if(n&&n.cond){const s=t[n.cond[0]],i=n.cond[1],r=n.cond[2];if(i=="="&&s!=r||i=="!="&&s==r)return!1}return!0}function Ee(n,e,t,s,i,r){for(const[o,a,c,l]of e)if(ae(l,i,r))if(a){let u=1;if(l&&"repeat"in l){if(u=typeof l.repeat=="string"?i[l.repeat]:l.repeat,u>65535)throw new Error(`Number of repetitions is too big (${u})`);i[a]=[]}for(let h=0;h<u&&t<s;h++){let m;if(Array.isArray(c))m={},t=Ee(n,c,t,s,m,r);else{switch(c){case"int":switch(o){case 8:m=n.getInt8(t);break;case 16:m=n.getInt16(t);break;case 32:m=n.getInt32(t);break}break;case"uint":switch(o){case 8:m=n.getUint8(t);break;case 16:m=n.getUint16(t);break;case 32:m=n.getUint32(t);break}break}t+=o/8}l&&"repeat"in l?i[a].push(m):i[a]=m}}else t+=o/8;return t}function Ie(n,e=0,t=-1){t=t==-1?n.byteLength:t;const s={st:e,en:t,buffer:n.buffer,children:[]};for(;e+8<=t;){const i=e,r=n.getUint32(e),o=n.getUint32(e+4);(r<8||i+r>t)&&console.warn(`Invalid box size: ${r}`),e+=8;const a={fourcc:o,st:e,en:i+r,buffer:n.buffer};if(o in g){const c=g[o];try{c.fullbox&&(a.fields={version:n.getUint8(e),flags:n.getUint8(e+1)<<16|n.getUint16(e+2)},e+=4),c.fields&&(a.fields=a.fields||{},e=Ee(n,c.fields,e,a.en,a.fields,a.fields)),c.cont&&Object.assign(a,Ie(n,e,a.en)),c.many?(s["$"+c.id]=s["$"+c.id]||[],s["$"+c.id].push(a)):s["$"+c.id]=a}catch(l){console.warn(`Unable to decode "${c.id}" box @ ${i}:`,l),a.error=l}}e=i+Math.max(r,8),s.children.push(a)}return s}function $e(n,e,t){let s=0;for(const[i,r,o,a]of n)if(ae(a,e,t))if(r){const c=a&&"repeat"in a?e[r]:[e[r]];for(const l of c)Array.isArray(o)?s+=$e(o,l,t):s+=i/8}else s+=i/8;return s}function xe(n,e,t,s,i){for(const[r,o,a,c]of e)if(ae(c,s,i))if(o){const l=c&&"repeat"in c?s[o]:[s[o]];for(const u of l)if(Array.isArray(a))t=xe(n,a,t,u,i);else{switch(a){case"int":switch(r){case 8:n.setInt8(t,u);break;case 16:n.setInt16(t,u);break;case 32:n.setInt32(t,u);break}break;case"uint":switch(r){case 8:n.setUint8(t,u);break;case 16:n.setUint16(t,u);break;case 32:n.setUint32(t,u);break}break}t+=r/8}}else t+=r/8;return t}function ne(n,e=[]){let t=0;for(const s of n){if(s.buffer){t+=s.en-s.st+8,e.push(s.buffer.slice(s.st-8,s.en));continue}let i=8,r=[],o=0;if(s.fourcc in g){const l=g[s.fourcc];l.fullbox&&(i+=4),l.fields&&(i+=$e(l.fields,s.fields,s.fields))}s.children&&([r,o]=ne(s.children));const a=new ArrayBuffer(i),c=new DataView(a);if(c.setUint32(0,i+o),c.setUint32(4,s.fourcc),s.fourcc in g){const l=g[s.fourcc];let u=8;l.fullbox&&(c.setUint8(u,s.fields.version),c.setUint8(u+1,s.fields.flags>>16),c.setUint16(u+2,s.fields.flags&65535),u+=4),l.fields&&xe(c,l.fields,u,s.fields,s.fields)}e.push(a),e=e.concat(r),t+=i+o}return[e,t]}function S(n,e,t=null){return Array.isArray(e)&&!t?{fourcc:n,children:e}:t?{fourcc:n,fields:e,children:t}:{fourcc:n,fields:e}}class dt{constructor(){this.inited=!1,this.seqNum=1,this.trackDurations={}}appendInitialChunk(e){this.inited=!0;for(const t of e.$moov.$trak)this.trackDurations[t.$tkhd.fields.trackId]=t.$mdia.$mdhd.fields.duration;return ne(e.children.map(t=>t.fourcc==g.moov?S(g.moov,[...t.children,S(g.mvex,t.$trak.map(s=>S(g.trex,{trackId:s.$tkhd.fields.trackId,defaultSampleDescriptionIndex:1,defaultSampleDuration:0,defaultSampleSize:0,defaultSampleFlags:0})))]):t))[0]}appendSubsequentChunk(e){const t=ne([e.$mdat,S(g.moof,[S(g.mfhd,{seqNum:this.seqNum}),...e.$moov.$trak.map(s=>{const i=!!s.$mdia.$minf.$smhd,r=!!s.$mdia.$minf.$stbl.$ctts,o=i?33554432:16842752,a=s.$mdia.$minf.$stbl.$stsz.fields.samples,c=!a,l=s.$mdia.$minf.$stbl.$stco.fields.chunkOffset.map(d=>S(g.trun,{version:0,flags:257|(c?0:512)|(r?2048:0),sampleCount:0,dataOffset:d-e.$mdat.st-(e.$mdat.en-e.$mdat.st),samples:[]})),u=s.$mdia.$minf.$stbl.$stsc.fields.entries,h=[],m=[];for(let d=0;d<u.length;d++){const k=d<u.length-1?u[d+1].firstChunk:l.length+1;for(let w=u[d].firstChunk;w<k;w++)for(let D=0;D<u[d].samplesPerChunk;D++){const z={flags:o};h.push(z),m.push(l[w-1]),l[w-1].fields.sampleCount+=1,l[w-1].fields.samples.push(z)}}if(!c)for(let d=0;d<a.length;d++)h[d].size=a[d].size;let p=0;for(const d of s.$mdia.$minf.$stbl.$stts.fields.entries){for(let k=p;k<p+d.sampleCount;k++)h[k].duration=d.sampleDelta;p+=d.sampleCount}if(i||(l[0].fields.flags|=4,l[0].fields.firstSampleFlags=33554432),r){let d=0;for(const k of s.$mdia.$minf.$stbl.$ctts.fields.entries){for(let w=d;w<d+k.sampleCount;w++)h[w].sampleCompositionTimeOffset=k.sampleOffset;d+=k.sampleCount}}return S(g.traf,[S(g.tfhd,{version:0,flags:(c?16:0)|32|131072,trackId:s.$tkhd.fields.trackId,defaultSampleSize:c?s.$mdia.$minf.$stbl.$stsz.fields.sampleSize:0,defaultSampleFlags:i?0:65536}),S(g.tfdt,{version:0,flags:0,baseMediaDecodeTime:this.trackDurations[s.$tkhd.fields.trackId]}),...s.$mdia.$minf.$stbl.$sgpd?[s.$mdia.$minf.$stbl.$sgpd]:[],...s.$mdia.$minf.$stbl.$sbgp?[s.$mdia.$minf.$stbl.$sbgp]:[],...l])})])])[0];for(const s of e.$moov.$trak){const i=!!s.$mdia.$minf.$smhd;let r=0;for(const o of s.$mdia.$minf.$stbl.$stts.fields.entries)r+=o.sampleCount*o.sampleDelta;console.log(i?"audio track duration ":"video track duration ",s.$mdia.$mdhd.fields.duration,", computed ",r,", expected ~",i?48e3:16e3),this.trackDurations[s.$tkhd.fields.trackId]+=i?48e3:16e3}return this.seqNum+=1,t}appendChunk(e){const t=Ie(new DataView(e));return this.inited?this.appendSubsequentChunk(t):this.appendInitialChunk(t)}}const L=new Map;setInterval(()=>{const n=Y();for(const[e,t]of L)if(e!==n){for(const s in t)t[s].reject();L.delete(e)}},12e4);const Oe=100*1024*1024*1024;function ft(n){if(!n)return[0,0];const[,e]=n.split("="),t=e.split(", "),[s,i]=t[0].split("-");return[+s,+i||0]}function fe(n){return n[0]===0&&n[1]===1?new Response(new Uint8Array(2).buffer,{status:206,statusText:"Partial Content",headers:{"Accept-Ranges":"bytes","Transfer-Encoding":"chunked","Content-Range":`bytes 0-1/${Oe}`,"Content-Length":"2","Content-Type":"video/mp4"}}):null}class me{constructor(e,t){this.written=0,this.promised=0,this.withRange=!0,t[1]==0?(t[1]=Oe-1,this.withRange=!1):t[1]=t[0]+192*1024-1,this.stream=e,this.range=t,this.promised=t[1]-t[0]+1,this.response=new Promise(s=>{this.respond=i=>{s(i)}}),this.respond(new Response(new ReadableStream({start:s=>{this.controller=s},cancel:()=>{console.log("cancelled videostream"),this.destroy()}}),{status:this.withRange?206:200,statusText:this.withRange?"Partial Content":"OK",headers:this.withRange?{"Accept-Ranges":"bytes","Content-Range":`bytes ${t[0]}-${t[1]}/${t[1]+1}`,"Content-Length":`${t[1]-t[0]+1}`,"Content-Type":"video/mp4"}:{"Transfer-Encoding":"chunked","Content-Type":"video/mp4"}}))}destroy(){this.stream.handlers=this.stream.handlers.filter(e=>e!=this);try{this.controller&&this.controller.close()}catch(e){console.error(e)}!this.stream.handlers.length&&this.stream.stopped}pushBuffers(){let e=this.stream.firstOffs;for(const t of this.stream.buffers){const s=t.length;if(e+s>this.range[0]){if(e+s>=this.range[1]){const i=t.slice(this.range[0]-e,this.range[1]-e+1);this.written+=i.length,this.controller.enqueue(i),this.destroy();return}else if(e==this.range[0])this.written+=t.length,this.controller.enqueue(t);else{const i=t.slice(this.range[0]-e);this.written+=i.length,this.controller.enqueue(i)}this.range[0]=e+s}e+=s}}}class y{constructor(e){this.params=e,this.baseTs=0,this.curDelay=2e3,this.buffers=[],this.firstOffs=0,this.handlers=[],y.instance=this,this.info=JSON.parse(decodeURIComponent(this.params)),this.baseTs=+this.info.timeMs||0,this.fragmentedMpeg=new dt,this.nextChunk()}destroy(){console.log("stream destroyed"),y.instance=null,this.stopped=!0,clearTimeout(this.timeout);for(const e of this.handlers)e.destroy()}async requestFilePartFromWorker(){const e=JSON.stringify(this.info),t=Y();let s=L.get(t);s||L.set(t,s={});let i=s[e];return i||(i=s[e]=j(),this.info.timeMs=-this.curDelay,b.invoke("requestVideoStreamPart",this.info,void 0,t).then(i.resolve.bind(i),i.reject.bind(i)).finally(()=>{s[e]===i&&(delete s[e],Object.keys(s).length||L.delete(t))}),i)}cleanupBuffers(){let e=0;for(let t=this.buffers.length-1;t>=1;t--)if(e+=this.buffers[t].length,e>4*1024*1024){for(let s=0;s<t;s++)this.firstOffs+=this.buffers[s].length;this.buffers=this.buffers.slice(t);return}}async nextChunk(){const e=Date.now(),t=await this.requestFilePartFromWorker();if(console.log("recvd",t.mtime,", ",t.bytes.byteLength," bytes"),this.stopped)return;if(this.lastTime==t.mtime||this.lastSize==t.bytes.byteLength){this.timeout=setTimeout(this.nextChunk.bind(this),200);return}this.lastTime=t.mtime,this.lastSize=t.bytes.byteLength;const s=t.bytes.buffer.slice(32),i=this.fragmentedMpeg.appendChunk(s);this.buffers.push(...i.map(o=>new Uint8Array(o)));for(const o of this.handlers)o.pushBuffers();this.cleanupBuffers();const r=Date.now()-e;if(console.log("delay = ",this.curDelay,", dt = ",r,", time left = ",1e3-r,", buffer# = ",this.buffers.length,", handler# = ",this.handlers.length),this.curDelay>1e3){this.curDelay-=1e3,this.timeout=setTimeout(this.nextChunk.bind(this),100);return}this.timeout=setTimeout(this.nextChunk.bind(this),1e3-r)}async response(e){const t=fe(e);if(t)return t;const s=new me(this,e);return this.handlers.push(s),s.response}handle(e,t){const s=fe(t);if(s){e.respondWith(s);return}const i=new me(this,t);this.handlers.push(i)}}function mt(n,e){if(e=="abort"){y.instance&&y.instance.destroy(),n.respondWith(new Response(""));return}const t=ft(n.request.headers.get("Range"));let s;y.instance?y.instance.params==e?s=y.instance:(y.instance.destroy(),s=new y(e)):s=new y(e),n.respondWith(s.response(t))}const pt={name:"tweb",version:7,stores:[{name:"session"},{name:"stickerSets"},{name:"users"},{name:"chats"},{name:"dialogs"},{name:"messages"}]},gt="assets/img/logo_filled_rounded.png",wt="assets/img/logo_plain.svg";function Re(n,e,t){const s=t&&new Set(t),i=c=>Object.keys(c).filter(l=>c[l]!==void 0),r=t?c=>i(c).filter(l=>!s.has(l)):i,o=typeof n;return n&&e&&o==="object"&&o===typeof e?r(n).length===r(e).length&&r(n).every(c=>Re(n[c],e[c],t)):n===e}function kt(n,e){if(e)for(const t in e)e[t]!==void 0&&(n[t]=e[t]);return n}const F=class F{constructor(e){kt(this,e),I.test&&(this.name+="_test"),this.storageIsAvailable=!0,this.log=q(["IDB",e.name].join("-")),this.log("constructor"),this.openDatabase(!0),F.INSTANCES.push(this)}isAvailable(){return this.storageIsAvailable}openDatabase(e=!1){if(this.openDbPromise&&!e)return this.openDbPromise;const t=(o,a)=>{const c=Array.from(o.indexNames);for(const l of c)o.deleteIndex(l);if(a.indexes?.length)for(const l of a.indexes)o.indexNames.contains(l.indexName)||o.createIndex(l.indexName,l.keyPath,l.objectParameters)},s=(o,a)=>{const c=o.createObjectStore(a.name);t(c,a)};try{var i=indexedDB.open(this.name,this.version);if(!i)return Promise.reject()}catch(o){return this.log.error("error opening db",o.message),this.storageIsAvailable=!1,Promise.reject(o)}let r=!1;return setTimeout(()=>{r||i.onerror(W("IDB_CREATE_TIMEOUT"))},3e3),this.openDbPromise=new Promise((o,a)=>{i.onsuccess=c=>{r=!0;const l=i.result;let u=!1;this.log("Opened"),l.onerror=h=>{this.storageIsAvailable=!1,this.log.error("Error creating/accessing IndexedDB database",h),a(h)},l.onclose=h=>{this.log.error("closed:",h),!u&&this.openDatabase()},l.onabort=h=>{this.log.error("abort:",h);const m=h.target;this.openDatabase(u=!0),m.onerror&&m.onerror(h),l.close()},l.onversionchange=h=>{this.log.error("onversionchange, lol?")},o(this.db=l)},i.onerror=c=>{r=!0,this.storageIsAvailable=!1,this.log.error("Error creating/accessing IndexedDB database",c),a(c)},i.onupgradeneeded=c=>{r=!0,this.log.warn("performing idb upgrade from",c.oldVersion,"to",c.newVersion);const l=c.target,u=l.result;this.stores.forEach(h=>{if(!u.objectStoreNames.contains(h.name))s(u,h);else{const p=l.transaction.objectStore(h.name);t(p,h)}})}})}static create(e){return this.INSTANCES.find(t=>t.name===e.name)??new F(e)}static closeDatabases(e){this.INSTANCES.forEach(t=>{if(e&&e===t)return;const s=t.db;s&&(s.onclose=()=>{},s.close())})}};F.INSTANCES=[];let ie=F;class bt{constructor(e,t){this.storeName=t,this.log=q(["IDB",e.name,t].join("-")),this.idb=ie.create(e)}delete(e,t){const s=Array.isArray(e);return s||(e=[].concat(e)),this.getObjectStore("readwrite",i=>{const r=e.map(o=>i.delete(o));return s?r:r[0]},"",t)}clear(e){return this.getObjectStore("readwrite",t=>t.clear(),"",e)}save(e,t,s){const i=Array.isArray(e);return i||(e=[].concat(e),t=[].concat(t)),this.getObjectStore("readwrite",r=>{const o=e.map((a,c)=>r.put(t[c],a));return i?o:o[0]},"",s)}get(e,t){const s=Array.isArray(e);if(s){if(!e.length)return Promise.resolve([])}else{if(!e)return;e=[].concat(e)}return this.getObjectStore("readonly",i=>{const r=e.map(o=>i.get(o));return s?r:r[0]},"",t)}getObjectStore(e,t,s,i=this.storeName){let r;return s&&(r=performance.now(),this.log(s+": start")),this.idb.openDatabase().then(o=>new Promise((a,c)=>{const l=o.transaction([i],e),u=()=>{clearTimeout(p),c(l.error)},h=()=>{clearTimeout(p),s&&this.log(s+": end",performance.now()-r);const $=w.map(G=>G.result);a(k?$:$[0])};l.onerror=u;const m=e==="readwrite";m&&(l.oncomplete=()=>h());const p=setTimeout(()=>{this.log.error("transaction not finished",l,s)},1e4),d=t(l.objectStore(i)),k=Array.isArray(d),w=k?d:[].concat(d);if(m)return;const D=w.length;let z=D;const We=()=>{l.error||--z||h()};for(let $=0;$<D;++$){const G=w[$];G.onerror=u,G.onsuccess=We}}))}getAll(e){return this.getObjectStore("readonly",t=>t.getAll(),"",e)}}const T=self,yt=location.protocol+"//"+location.hostname+location.pathname.split("/").slice(0,-1).join("/")+"/",vt=11500;let De=0,Me=!0;class St{constructor(e,t,s){this.defaults=s,this.cache={},this.storage=new bt(e,t)}getDefault(e){const t=this.defaults[e];return typeof t=="function"?t():t}get(e){return this.cache.hasOwnProperty(e)?this.cache[e]:this.storage.get(e).then(s=>s,()=>{}).then(s=>this.cache.hasOwnProperty(e)?this.cache[e]:(s??(s=this.getDefault(e)),this.cache[e]=s))}getCached(e){const t=this.get(e);if(t instanceof Promise)throw"no property";return t}async set(e,t){const s=this.cache[e]??this.defaults[e];if(!Re(s,t)){this.cache[e]=t;try{this.storage.save(e,t)}catch{}}}}const _e={push_mute_until:0,push_lang:{push_message_nopreview:"You have a new message",push_action_mute1d:"Mute for 24H",push_action_settings:"Settings"},push_settings:{}},E=new St(pt,"session",_e);for(const n in _e)E.get(n);T.addEventListener("push",n=>{const e=n.data.json();f("push",{...e});try{const[t,s,i]=[E.getCached("push_mute_until"),E.getCached("push_settings"),E.getCached("push_lang")],r=Date.now();if(Le()&&t&&r<t)throw`supress notification because mute for ${Math.ceil((t-r)/6e4)} min`;if(Date.now()-De<=vt&&Me)throw"supress notification because some instance is alive";const a=At(e,s,i);n.waitUntil(a)}catch(t){f(t)}});T.addEventListener("notificationclick",n=>{const e=n.notification;f("on notification click",e),e.close();const t=n.action;if(t==="mute1d"&&Le()){f("[SW] mute for 1d"),E.set("push_mute_until",Date.now()+864e5);return}const s=e.data;if(!s)return;const i=T.clients.matchAll({type:"window"}).then(r=>{s.action=t,O=s;for(let o=0;o<r.length;++o){const a=r[o];if("focus"in a){a.focus(),b.invokeVoid("pushClick",O,a),O=void 0;return}}if(T.clients.openWindow)return Promise.resolve(E.get("push_settings")).then(o=>T.clients.openWindow(o.baseUrl||yt))}).catch(r=>{f.error("Clients.matchAll error",r)});n.waitUntil(i)});T.addEventListener("notificationclose",Tt);const re=new Set;let O;function Tt(n){Pt(n.notification)}function Pt(n){re.delete(n)}function Ct(n){for(const t of re)try{if(n&&t.tag!==n)continue;t.close(),re.delete(t)}catch{}let e;return"getNotifications"in T.registration?e=T.registration.getNotifications({tag:n}).then(t=>{for(let s=0,i=t.length;s<i;++s)try{t[s].close()}catch{}}).catch(t=>{f.error("Offline register SW error",t)}):e=Promise.resolve(),e}function Le(){return ge}function At(n,e,t){let s=n.title||"Telegram",i=n.description||"",r;n.custom&&(n.custom.channel_id?r=""+-n.custom.channel_id:n.custom.chat_id?r=""+-n.custom.chat_id:r=n.custom.from_id||""),n.custom.peerId=""+r;let o="peer"+r;const a=r+"_"+n.custom.msg_id;if(B.has(a)){const h="ignoring push";throw f.warn(h,n),B.delete(a),h}e?.nopreview&&(s="Telegram",i=t.push_message_nopreview,o="unknown_peer");const c=[{action:"mute1d",title:t.push_action_mute1d}],l={body:i,icon:gt,tag:o,data:n,actions:c,badge:wt,silent:n.custom.silent==="1"};return f("show notify",s,i,n,l),T.registration.showNotification(s,l).catch(h=>{f.error("Show notification promise",h)})}function Et(n,e){De=Date.now(),Me=n.localNotifications,O&&e&&(b.invokeVoid("pushClick",O,e),O=void 0),n.lang&&E.set("push_lang",n.lang),n.settings&&E.set("push_settings",n.settings)}const B=new Map;function It(n){B.set(n,Date.now())}setInterval(()=>{const n=Date.now();B.forEach((e,t)=>{n-e>3e4&&B.delete(t)})},30*6e4);const $t=Date.now()%Math.random()*1e8|0;function ee(n,e){const t=n.indexOf(e);return(t===-1?void 0:n.splice(t,1))?.[0]}function xt(n,e){const t=n.findIndex(e);return t!==-1?n.splice(t,1)[0]:void 0}class Ot{constructor(e){this._constructor(e)}_constructor(e){this.reuseResults=e,this.listeners={},this.listenerResults={}}addEventListener(e,t,s){var i;if(((i=this.listeners)[e]??(i[e]=[])).push({callback:t,options:s}),this.listenerResults.hasOwnProperty(e)&&(t(...this.listenerResults[e]),s?.once)){this.listeners[e].pop();return}}addMultipleEventsListeners(e){for(const t in e)this.addEventListener(t,e[t])}removeEventListener(e,t,s){this.listeners[e]&&xt(this.listeners[e],i=>i.callback===t)}invokeListenerCallback(e,t,...s){let i,r;try{i=t.callback(...s)}catch(o){r=o}if(t.options?.once&&this.removeEventListener(e,t.callback),r)throw r;return i}_dispatchEvent(e,t,...s){this.reuseResults&&(this.listenerResults[e]=s);const i=t&&[],r=this.listeners[e];return r&&r.slice().forEach(a=>{if(r.findIndex(u=>u.callback===a.callback)===-1)return;const l=this.invokeListenerCallback(e,a,...s);i&&i.push(l)}),i}dispatchResultableEvent(e,...t){return this._dispatchEvent(e,!0,...t)}dispatchEvent(e,...t){this._dispatchEvent(e,!1,...t)}cleanup(){this.listeners={},this.listenerResults={}}}const Rt=!0;class Dt extends Ot{constructor(e){super(!1),this.logSuffix=e,this.onMessage=t=>{const s=t.data,i=t.source||t.currentTarget;this.processTaskMap[s.type](s,i,t)},this.processResultTask=t=>{const{taskId:s,result:i,error:r}=t.payload,o=this.awaiting[s];o&&(this.debug&&this.log.debug("done",o.taskType,i,r),"error"in t.payload?o.reject(r):o.resolve(i),delete this.awaiting[s])},this.processAckTask=t=>{const s=t.payload,i=this.awaiting[s.taskId];if(!i)return;const r=i.resolve,o={cached:s.cached,result:s.cached?"result"in s?Promise.resolve(s.result):Promise.reject(s.error):new Promise((a,c)=>{i.resolve=a,i.reject=c})};r(o),s.cached&&delete this.awaiting[s.taskId]},this.processPingTask=(t,s,i)=>{this.pushTask(this.createTask("pong",void 0),i.source)},this.processPongTask=(t,s,i)=>{const r=this.pingResolves.get(s);r&&(this.pingResolves.delete(s),r())},this.processCloseTask=(t,s,i)=>{this.detachPort(s)},this.processBatchTask=(t,s,i)=>{const r={data:i.data,source:i.source,currentTarget:i.currentTarget};t.payload.forEach(o=>{r.data=o,this.onMessage(r)})},this.processLockTask=(t,s,i)=>{const r=t.payload;this.requestedLocks.has(r)||(this.requestedLocks.set(r,s),navigator.locks.request(r,()=>{this.processCloseTask(void 0,s,void 0),this.requestedLocks.delete(r)}))},this.processInvokeTask=async(t,s,i)=>{const r=t.id,o=t.payload;let a,c,l;o.void||(a={taskId:r},c=this.createTask("result",a)),o.withAck&&(l=this.createTask("ack",{taskId:r,cached:!0}));let u;try{const h=this.listeners[o.type];if(!h?.length)throw new Error("no listener");const m=h[0];let p=this.invokeListenerCallback(o.type,m,o.payload,s,i);if(o.void)return;if(u=p instanceof Promise,l){const d=!u;if(l.payload.cached=d,d&&(l.payload.result=p),this.pushTask(l,s),d)return}u&&(p=await p),a.result=p}catch(h){if(this.log.error("worker task error:",h,t),o.void)return;if(l&&l.payload.cached){l.payload.error=h,this.pushTask(l,s);return}a.error=h}this.pushTask(c,s)},this.listenPorts=[],this.sendPorts=[],this.pingResolves=new Map,this.taskId=0,this.awaiting={},this.pending=new Map,this.log=q("MP"+(e?"-"+e:"")),this.debug=oe,this.heldLocks=new Map,this.requestedLocks=new Map,this.processTaskMap={result:this.processResultTask,ack:this.processAckTask,invoke:this.processInvokeTask,ping:this.processPingTask,pong:this.processPongTask,close:this.processCloseTask,lock:this.processLockTask,batch:this.processBatchTask}}setOnPortDisconnect(e){this.onPortDisconnect=e}attachPort(e){this.attachListenPort(e),this.attachSendPort(e)}attachListenPort(e){this.listenPorts.push(e),e.addEventListener("message",this.onMessage)}attachSendPort(e){if(this.log.warn("attaching send port"),e.start?.(),this.sendPorts.push(e),typeof window<"u"&&Rt)if("locks"in navigator){const t=["lock",$t,this.logSuffix||"",Math.random()*2147483647|0].join("-");this.log.warn("created lock",t);const s=new Promise(i=>this.heldLocks.set(e,{resolve:i,id:t})).then(()=>this.heldLocks.delete(e));navigator.locks.request(t,()=>(this.resendLockTask(e),s))}else window.addEventListener("beforeunload",()=>{const t=this.createTask("close",void 0);this.postMessage(void 0,t)});this.releasePending()}resendLockTask(e){const t=this.heldLocks.get(e);t&&this.pushTask(this.createTask("lock",t.id),e)}detachPort(e){this.log.warn("disconnecting port"),ee(this.listenPorts,e),ee(this.sendPorts,e),e.removeEventListener?.("message",this.onMessage),e.close?.(),this.onPortDisconnect?.(e),this.heldLocks.get(e)?.resolve();const s=W("PORT_DISCONNECTED");for(const i in this.awaiting){const r=this.awaiting[i];r.port===e&&(r.reject(s),delete this.awaiting[i])}}postMessage(e,t){(Array.isArray(e)?e:e?[e]:this.sendPorts).forEach(i=>{i.postMessage(t,t.transfer)})}async releasePending(){this.releasingPending||(this.releasingPending=!0,await Promise.resolve(),this.debug&&this.log.debug("releasing tasks, length:",this.pending.size),this.pending.forEach((e,t)=>{let s=e;{let r;s=[],e.forEach(o=>{o.transfer?(r=void 0,s.push(o)):(r||(r=this.createTask("batch",[]),s.push(r)),r.payload.push(o))})}const i=t?[t]:this.sendPorts;i.length&&(s.forEach(r=>{try{this.postMessage(i,r)}catch(o){this.log.error("postMessage error:",o,r,i)}}),this.pending.delete(t))}),this.debug&&this.log.debug("released tasks"),this.releasingPending=!1)}createTask(e,t,s){return{type:e,payload:t,id:this.taskId++,transfer:s}}createInvokeTask(e,t,s,i,r){return this.createTask("invoke",{type:e,payload:t,withAck:s,void:i},r)}pushTask(e,t){let s=this.pending.get(t);s||this.pending.set(t,s=[]),s.push(e),this.releasePending()}invokeVoid(e,t,s,i){const r=this.createInvokeTask(e,t,void 0,!0,i);this.pushTask(r,s)}invoke(e,t,s,i,r){this.debug&&this.log.debug("start",e,t);let o;const a=new Promise((c,l)=>{o=this.createInvokeTask(e,t,s,void 0,r),this.awaiting[o.id]={resolve:c,reject:l,taskType:e,port:i},this.pushTask(o,i)});if(Ue){a.finally(()=>{clearInterval(c)});const c=A.setInterval(()=>{this.log.error("task still has no result",o,i)},6e4)}return a}invokeExceptSource(e,t,s){const i=this.sendPorts.slice();ee(i,s),i.forEach(r=>{this.invokeVoid(e,t,r)})}}class Mt extends Dt{constructor(){super("SERVICE"),ce&&(ce.serviceMessagePort=this)}}function _t(n,e,t){const s=(i,r)=>{n.attachListenPort(i),r&&n.attachSendPort(r),e?.(i)};n.setOnPortDisconnect(t),typeof SharedWorkerGlobalScope<"u"?A.addEventListener("connect",i=>s(i.source,i.source)):typeof ServiceWorkerGlobalScope<"u"?s(A,null):s(A,A)}const v=new Map,te=W("UNKNOWN"),Lt=!1;self.downloadMap=v;const Nt={download:n=>{const{id:e}=n;if(v.has(e))return Promise.reject(te);const t=new CountQueuingStrategy({highWaterMark:1}),s=j();s.then(()=>{setTimeout(()=>{v.delete(e)},5e3)},()=>{v.delete(e)});let i;const r=new ReadableStream({start:a=>{i=a},cancel:a=>{s.reject(te)}},t),o={...n,readableStream:r,promise:s,controller:i};return v.set(e,o),s.catch(()=>{throw te})},downloadChunk:({id:n,chunk:e})=>{const t=v.get(n);return t?t.controller.enqueue(e):Promise.reject()},downloadFinalize:n=>{const e=v.get(n);return e?(e.promise.resolve(),e.controller.close()):Promise.reject()},downloadCancel:n=>{const e=v.get(n);if(e)return e.promise.reject(),e.controller.error()}};function Ft(n){return n.addMultipleEventsListeners(Nt),{onDownloadFetch:Wt,onClosedWindows:Bt}}function Wt(n,e){const t=Se(100).then(()=>{const s=v.get(e);if(!s||s.used&&!Lt)return;s.used=!0;const i=s.readableStream;return new Response(i,{headers:s.headers})});n.respondWith(t)}function Bt(){if(v.size)for(const[n,e]of v)e.controller.error()}const N={};function Ut(n){return{files:n.getAll("files"),title:n.get("title"),text:n.get("text"),url:n.get("url")}}async function qt(n,e){try{f("share data",n);const t=Ut(n);(N[e]??(N[e]=[])).push(t)}catch(t){f.warn("something wrong with the data",t)}}function jt(n){const e=N[n.id];e&&(delete N[n.id],f("releasing share events to client:",n.id,"length:",e.length),e.forEach(t=>{b.invokeVoid("share",t,n)}))}function zt(n,e){const t=n.request.formData().then(s=>(qt(s,n.resultingClientId),Response.redirect("..")));n.respondWith(t)}const f=q("SW",M.Error|M.Debug|M.Log|M.Warn,!0),P=self;let R;const Y=()=>R;f("init");const Gt=n=>{const e=new MessageChannel;b.attachPort(R=e.port1),b.invokeVoid("port",void 0,n,[e.port2])},Vt=n=>{!C.size&&!R&&(f("sending message port for mtproto"),Gt(n))},Ne=n=>{if(f("window connected",n.id,"windows before",C.size),n.frameType==="none"){f.warn("maybe a bugged Safari starting window",n.id);return}f("windows",Array.from(C)),b.invokeVoid("hello",void 0,n),Vt(n),C.set(n.id,n),jt(n)},b=new Mt;b.addMultipleEventsListeners({notificationsClear:Ct,toggleStorages:({enabled:n,clearWrite:e})=>{H.toggleStorage(n,e)},pushPing:(n,e)=>{Et(n,e)},hello:(n,e)=>{Ne(e)},shownNotification:It});const{onDownloadFetch:Ht,onClosedWindows:Kt}=Ft(b);we().then(n=>{f(`got ${n.length} windows from the start`),n.forEach(e=>{Ne(e)})});const C=new Map;self.connectedWindows=C;_t(b,void 0,n=>{if(f("something has disconnected",n),!(n instanceof WindowClient)||!C.has(n.id)){f.warn("it is not a window");return}C.delete(n.id),f("window disconnected, left",C.size),C.size||(f.warn("no windows left"),R&&(b.detachPort(R),R=void 0),Kt())});const Jt=n=>{if(!pe&&n.request.url.indexOf(location.origin+"/")===0&&n.request.url.match(/\.(js|css|jpe?g|json|wasm|png|mp3|svg|tgs|ico|woff2?|ttf|webmanifest?)(?:\?.*)?$/))return n.respondWith(Ke(n));try{const[e,t]=n.request.url.split("/").slice(-2);switch(e){case"stream":{rt(n,t);break}case"vstream":{mt(n,t);break}case"download":{Ht(n,t);break}case"share":{zt(n,t);break}case"ping":{n.respondWith(new Response("pong"));break}}}catch(e){f.error("fetch error",e),n.respondWith(new Response("",{status:500,statusText:"Internal Server Error",headers:{"Cache-Control":"no-cache"}}))}},Fe=()=>{P.onfetch=Jt};P.addEventListener("install",n=>{f("installing"),n.waitUntil(P.skipWaiting().then(()=>f("skipped waiting")))});P.addEventListener("activate",n=>{f("activating",P),n.waitUntil(P.caches.delete(Te).then(()=>f("cleared assets cache"))),n.waitUntil(P.clients.claim().then(()=>f("claimed clients")))});P.onoffline=P.ononline=Fe;Fe();
//# sourceMappingURL=sw-WeADWGhz.js.map
